{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartio</title>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Cartio</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
      <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://kit.fontawesome.com/8b6abeeef6.js" crossorigin="anonymous"></script>
      <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
      <link href="{% static 'Commerce/styles.css' %}" rel="stylesheet">
  </head>
  
</head>
<body>
  <script>
    function notiClick(id) {
        const notiBell = document.getElementById(`bell${id}`);
        let notifications = document.querySelector('.position-absolute');

        fetch(`/noti_click/${id}`, {
            method: 'POST',
            headers: {
                'Content-type': 'application/json', "X-CSRFTOKEN": "{{csrf_token}}",
            },
            body: JSON.stringify({})
        })
        .then(response =>{
            return response.json()
        }) 
        .then(data => {
          if (notifications) {
            notifications.style.display = 'none';
          }
            console.log('Notifications:', data.data.notifs);
        })
        .catch(error => console.log(error, 'ERROR'))
    }

   function notiChange(id) {
        const notifs = document.getElementById(`noti${id}`);

        fetch(`/noti_change/${id}`, {
            method: 'POST',
            headers: {
                'Content-type': 'application/json', "X-CSRFTOKEN": "{{csrf_token}}",
            },
            body: JSON.stringify({})
        })
        .then(response =>{ 
            return response.json()
        }) 
        .then(data => {
            console.log('Read:', data.data.notifs);
        })
        .catch(error => console.log(error, 'ERROR'))
    }

     document.addEventListener('DOMContentLoaded', function() {
        let notifications = document.querySelectorAll('.notibell');
        notifications.forEach(button => {
            button.addEventListener('click', function(){
              user_id = button.getAttribute('data-id');
              notiClick(user_id)
            })
        })
        let dropNoti = document.querySelectorAll('.dropdown-item');
        dropNoti.forEach(button => {
            let isRead = button.getAttribute('data-reading');
            let circleIcon = button.querySelector('.fa-circle');   
            if (isRead === 'True') {
              button.style.backgroundColor = '#f2f2f2'; 
              circleIcon.remove()   
            }
          button.addEventListener('click', function(){
            noti_id = button.getAttribute('data-id');
            notiChange(noti_id);
          });
        });
     });
  </script>
            <nav class="navbar navbar-expand-lg bg-body-tertiary">
                <div class="container-fluid">
                  <a class="navbar-brand" href="{% url 'index' %}"><img class="nav-logo" src='media/images/navlogo.jpg'></a>
                  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                  </button>
                  <div class="collapse navbar-collapse" id="navbarText">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                      {% if user.is_authenticated %}
                      <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="{% url 'profile' profile_id=user.id %}">{{ request.user.profile }}</a>
                      </li>
                      {% endif %}
                      <li class="nav-item">
                        <a class="nav-link" href="{% url 'index' %}">Home</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="{% url 'category' %}">Categories</a>
                      </li>
                      {% if user.is_authenticated %}
                      <li class="nav-item">
                        <a class="nav-link" href="{% url 'wishlist' %}">Wishlist</a>
                      </li>
                      {% endif %}
                      {% if user.is_authenticated %}
                      <li class="nav-item">
                        <a class="nav-link" href="{% url 'create_listing' %}">Create a listing</a>
                      </li>
                      {% endif %}
                      <li class="nav-item">
                        <a class="nav-link" href="{% url 'closed_listing' %}">Closed listings</a>
                      </li>
                    </ul>
                    {% if user.is_authenticated %}
                        <div class="btn-group dropstart">
                          {% if button_disabled %}
                            <button class="notibell" id="bell{{user.id}}" data-bs-toggle="dropdown" data-id="{{ user.id }}" aria-expanded="false" disabled> 
                          {% else %}
                            <button class="notibell" id="bell{{user.id}}" data-bs-toggle="dropdown" data-id="{{ user.id }}" aria-expanded="false"> 
                          {% endif %}                 
                            <i class="fa-regular fa-bell fa-xl"></i>
                            {% if notifs.last.noti_count != 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                              {% if notifs.last.noti_count > 9 %}
                                  9+
                              {% else %}
                                  {{ notifs.last.noti_count}}
                              {% endif %}
                              <span class="visually-hidden">unread messages</span>
                            </span>
                            {% else %}
                                  <span style="display: none;"></span>
                            {% endif %}
                          </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                              <li class="more-noti"><b>Notifications</b></li>
                              {% for notif in notifs|dictsortreversed:"noti_time"|slice:":7" %}
                                    {% if notif.noti_follower %}
                                      {% if notif.noti_follower.profile_pic %}
                                        <li><a id="noti{{notif.id}}" class="dropdown-item"  data-reading="{{notif.noti_read}}" data-id="{{notif.id}}" href="{% url 'profile' profile_id=notif.noti_follower.user.id %}"><span id="noti-badge "></span><img class="comment-pic" src="{{notif.noti_follower.profile_pic.url}}"><div class='noti-content'><span class="noti-writing">{{ notif.noti_follower }} started following you</span></span><div class="noti-time"><span class="noti-time"><small>{{notif.noti_time|naturaltime}}</small></span></div></b><i class="fa-solid fa-circle fa-2xs" style="color: #dc3545;"></i></div></a></li>
                                      {% else %}
                                        <li><a id="noti{{notif.id}}" class="dropdown-item"  data-reading="{{notif.noti_read}}" data-id="{{notif.id}}" href="{% url 'profile' profile_id=notif.noti_follower.user.id %}"><span id="noti-badge "></span><img class="comment-pic" src="../media/images/default_profile.png"><div class='noti-content'><span class="noti-writing">{{ notif.noti_follower }} started following you</span></span><div class="noti-time"><span class="noti-time"><small>{{notif.noti_time|naturaltime}}</small></span></div></b><i class="fa-solid fa-circle fa-2xs" style="color: #dc3545;"></i></div></a></li>
                                      {% endif %}
                                    {% elif notif.noti_bid %}
                                      {% if notif.noti_bid == request.user.profile %}
                                        {% if notif.noti_bid.profile_pic %}
                                          <li><a id="noti{{notif.id}}" class="dropdown-item"  data-reading="{{notif.noti_read}}" data-id="{{notif.id}}" href="{% url 'listing' listing_id=notif.noti_listing.id %}"><span id="noti-badge "></span><img class="comment-pic" src="{{notif.noti_bid.profile_pic.url}}"><div class='noti-content'><span class="noti-writing">You just bid on your listing<i class="noti_listing">{{notif.noti_listing }}</i></span></span><div class="noti-time"><span class="noti-time"><small>{{notif.noti_time|naturaltime}}</small></span></div></b><i class="fa-solid fa-circle fa-2xs" style="color: #dc3545;"></i></div></a></li>
                                        {% else %}
                                          <li><a id="noti{{notif.id}}" class="dropdown-item"  data-reading="{{notif.noti_read}}" data-id="{{notif.id}}" href="{% url 'listing' listing_id=notif.noti_listing.id %}"><span id="noti-badge "></span><img class="comment-pic" src="../media/images/default_profile.png"><div class='noti-content'><span class="noti-writing">You just bid on your listing<i class="noti_listing">{{notif.noti_listing }}</i></span></span><div class="noti-time"><span class="noti-time"><small>{{notif.noti_time|naturaltime}}</small></span></div></b><i class="fa-solid fa-circle fa-2xs" style="color: #dc3545;"></i></div></a></li>
                                        {% endif %}
                                      {% else %}  
                                        {% if notif.noti_bid.profile_pic %}                
                                          <li><a id="noti{{notif.id}}" class="dropdown-item"  data-reading="{{notif.noti_read}}" data-id="{{notif.id}}" href="{% url 'listing' listing_id=notif.noti_listing.id %}"><span id="noti-badge"></span><img class="comment-pic" src="{{notif.noti_bid.profile_pic.url}}"><div class='noti-content'><span class="noti-writing">{{ notif.noti_bid }} has just bid on your listing<i class="noti_listing">{{notif.noti_listing }}</i></span><div class="noti-time"><span class="noti-time"><small>{{notif.noti_time|naturaltime}}</small></span></div><i class="fa-solid fa-circle fa-2xs" style="color: #dc3545;"></i></div></a></li>      
                                        {% else %}
                                          <li><a id="noti{{notif.id}}" class="dropdown-item"  data-reading="{{notif.noti_read}}" data-id="{{notif.id}}" href="{% url 'listing' listing_id=notif.noti_listing.id %}"><span id="noti-badge"></span><img class="comment-pic" src="../media/images/default_profile.png"><div class='noti-content'><span class="noti-writing">{{ notif.noti_bid }} has just bid on your listing<i class="noti_listing">{{notif.noti_listing }}</i></span><div class="noti-time"><span class="noti-time"><small>{{notif.noti_time|naturaltime}}</small></span></div><i class="fa-solid fa-circle fa-2xs" style="color: #dc3545;"></i></div></a></li> 
                                        {% endif %}                 
                                      {% endif %}
                                    {% elif notif.noti_winner %}
                                      {% if notif.noti_winner.profile_pic %}
                                        <li><a id="noti{{notif.id}}" class="dropdown-item"  data-reading="{{notif.noti_read}}" data-id="{{notif.id}}" href="{% url 'listing' listing_id=notif.noti_listing.id %}"><span id="noti-badge"></span><img class="comment-pic" src="{{notif.noti_winner.profile_pic.url}}"><div class='noti-content'><span class="noti-writing">Congratulations, {{ notif.noti_winner }}! You just won the auction<i class="noti_listing">{{notif.noti_listing }}.</i></span><div class="noti-time"><span class="noti-time"><small>{{notif.noti_time|naturaltime}}</small></span></div><i class="fa-solid fa-circle fa-2xs" style="color: #dc3545;"></i></div></a></li>    
                                      {% else %} 
                                        <li><a id="noti{{notif.id}}" class="dropdown-item"  data-reading="{{notif.noti_read}}" data-id="{{notif.id}}" href="{% url 'listing' listing_id=notif.noti_listing.id %}"><span id="noti-badge"></span><img class="comment-pic" src="../media/images/default_profile.png"><div class='noti-content'><span class="noti-writing">Congratulations, {{ notif.noti_winner }}! You just won the auction<i class="noti_listing">{{notif.noti_listing }}.</i></span><div class="noti-time"><span class="noti-time"><small>{{notif.noti_time|naturaltime}}</small></span></div><i class="fa-solid fa-circle fa-2xs" style="color: #dc3545;"></i></div></a></li> 
                                      {% endif %}
                                    {% endif %}
                              {% empty %}
                                <li><a id="noti{{notif.id}}" class="dropdown-item" href="">No notifications to display</a></li>
                              {% endfor %}
                              {% if notifs|length > 7 %}
                                <li class="more-noti"><a href="{% url 'noti_page' %}">See more</a></li>
                              {% endif %}
                            </ul>
                        </div>
                      {% endif %}
                    {% if user.is_authenticated %}
                    <span class="navbar-text">
                        <a class="nav-link" href="{% url 'logout' %}">Logout</a>
                    </span>
                    {% else %}
                    {% if not loggin %}
                    <span class="navbar-text">
                      <a class="nav-link" href="{% url 'login' %}">Login</a>
                  </span>
                  {% endif %}
                  {% endif %}
                    
                  </div>
                </div>
            </nav>

        <div class="body">
            {% block body %}
            {% endblock %}          
        </div>
    
</body>
</html>